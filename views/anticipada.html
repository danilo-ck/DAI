{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-5" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
  <div class="container">
    <h1 class="display-4 mb-3">üîç B√∫squeda Anticipada</h1>
    <p class="lead mb-0">Encuentra productos escribiendo solo 3 caracteres</p>
  </div>
</div>

<div class="container py-5">
  <!-- Barra b√∫squeda -->
  <div class="card shadow-sm border-0 mb-4" style="border-radius: 15px;">
    <div class="card-body p-4">
      <label class="form-label fw-500 mb-3">Buscar productos</label>

      <div class="input-group input-group-lg">
        <input id="q"
               type="search"
               class="form-control"
               placeholder="Escribe al menos 3 caracteres‚Ä¶"
               style="border-radius: 10px 0 0 10px;"
               aria-label="Buscar productos">
        <span class="input-group-text" id="spinner" style="border-radius: 0 10px 10px 0; display: none;">
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          <small class="ms-2">Buscando‚Ä¶</small>
        </span>
      </div>

      <p id="hint" class="text-muted small mt-3 mb-0">
        Escribe 3 o m√°s caracteres para ver coincidencias.
      </p>

      <p id="error" class="alert alert-danger small mt-3 mb-0 hidden" style="display: none;"></p>
    </div>
  </div>

  <!-- Resultado resumen -->
  <div class="mb-4">
    <p id="result" class="h5 mb-3" style="display: none;">
      Resultados para "<span id="qEcho" class="fw-bold text-primary"></span>":
      <span id="count" class="fw-bold text-success">0</span> producto(s)
    </p>
    <p id="empty" class="alert alert-info small" style="display: none;">No hay resultados para tu b√∫squeda.</p>
  </div>

  <!-- CONTENEDOR TARJETAS -->
  <div id="tarjetas" class="row g-3"></div>

  <!-- TEMPLATE TARJETA -->
  <template id="plantilla">
    <div class="col-6 col-md-4 col-lg-3 col-xl-2">
      <div class="card h-100 border-0 shadow-sm" style="border-radius: 12px; overflow: hidden;">
        <a class="prod-link text-decoration-none" href="#" target="_blank" rel="noreferrer">
          <div class="bg-light d-flex align-items-center justify-content-center" style="min-height: 150px;">
            <img class="prod-img" style="max-width: 100%; max-height: 100%; object-fit: contain;" src="" alt="">
          </div>
        </a>

        <div class="card-body p-3 d-flex flex-column">
          <div class="prod-title card-title small fw-500 flex-grow-1" style="line-height: 1.3; min-height: 45px; overflow: hidden;"></div>

          <div class="mt-2">
            <div class="d-flex align-items-baseline gap-2">
              <span class="prod-price fw-bold text-dark"></span>
              <span class="prod-price-old text-muted text-decoration-line-through small" style="display: none;"></span>
            </div>
            <div class="prod-unit text-muted small mt-1"></div>
            <div class="prod-badge mt-2" style="display: none;">
              <span class="badge bg-danger">Rebajado</span>
            </div>
          </div>

          <div class="mt-3">
            <a class="btn-add btn btn-sm btn-warning w-100"
               href="#">
              A√±adir al carro
            </a>
          </div>
        </div>
      </div>
    </div>
  </template>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

<script>
  const input = document.getElementById("q");
  const spinner = document.getElementById("spinner");
  const hint = document.getElementById("hint");
  const errorEl = document.getElementById("error");

  const result = document.getElementById("result");
  const empty = document.getElementById("empty");
  const countEl = document.getElementById("count");
  const qEcho = document.getElementById("qEcho");

  const tarjetas = document.getElementById("tarjetas");
  const template = document.getElementById("plantilla");

  let timer = null;
  let controller = null;

  function setLoading(on) {
    spinner.style.display = on ? "inline-flex" : "none";
  }

  function showError(msg) {
    errorEl.textContent = msg;
    errorEl.style.display = "block";
  }

  function clearError() {
    errorEl.textContent = "";
    errorEl.style.display = "none";
  }

  function limpiarTarjetas() {
    tarjetas.replaceChildren();
  }

  function euro(n) {
    return (typeof n === "number" && isFinite(n)) ? `${n.toFixed(2)} ‚Ç¨` : "";
  }

  function muestraProducto(p) {
    const clonado = template.content.cloneNode(true);

    const id = p._id;
    const title = p.title || p.nombre || "Producto";
    const img = p.image || p.url_img || "";
    const link = p.link || p.url || "#";

    const isDiscounted = !!p.is_discounted && (typeof p.discounted_price === "number") && p.discounted_price > 0;
    const price = isDiscounted ? p.discounted_price : p.price;
    const priceOld = isDiscounted ? p.price : null;
    const unit = p.unit_price_text || p.precio_unitario || p.price_text || "";

    const a = clonado.querySelector(".prod-link");
    a.href = link;

    const im = clonado.querySelector(".prod-img");
    im.src = img;
    im.alt = title;

    clonado.querySelector(".prod-title").textContent = title;

    const priceEl = clonado.querySelector(".prod-price");
    priceEl.textContent = (typeof price === "number") ? euro(price) : (p.price_text || "Precio s/d");

    const unitEl = clonado.querySelector(".prod-unit");
    unitEl.textContent = unit;

    const badge = clonado.querySelector(".prod-badge");
    const oldEl = clonado.querySelector(".prod-price-old");
    if (isDiscounted) {
      badge.style.display = "block";
      if (typeof priceOld === "number") {
        oldEl.textContent = euro(priceOld);
        oldEl.style.display = "inline";
      }
    }

    const btnAdd = clonado.querySelector(".btn-add");
    if (id) btnAdd.href = `/al_carrito/${encodeURIComponent(id)}`;

    tarjetas.append(clonado);
  }

  async function doSearch(q) {
    clearError();

    if (q.length < 3) {
      hint.style.display = "block";
      result.style.display = "none";
      empty.style.display = "none";
      countEl.textContent = "0";
      qEcho.textContent = "";
      limpiarTarjetas();
      return;
    }

    if (controller) controller.abort();
    controller = new AbortController();

    setLoading(true);

    try {
      const res = await fetch(`/api/busqueda-anticipada/${encodeURIComponent(q)}`, {
        signal: controller.signal
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.error || `Error ${res.status}`);
      }

      const data = await res.json();

      hint.style.display = "none";
      result.style.display = "block";
      qEcho.textContent = q;

      const items = Array.isArray(data.items) ? data.items : [];
      const count = (typeof data.count === "number") ? data.count : items.length;
      countEl.textContent = String(count);

      limpiarTarjetas();

      if (items.length === 0) {
        empty.style.display = "block";
        return;
      } else {
        empty.style.display = "none";
      }

      for (const p of items) {
        muestraProducto(p);
      }

    } catch (e) {
      if (e.name === "AbortError") return;
      showError(e.message || "Error buscando");
      limpiarTarjetas();
      result.style.display = "none";
      empty.style.display = "none";
    } finally {
      setLoading(false);
    }
  }

  input.addEventListener("input", (e) => {
    const q = e.target.value.trim();
    clearTimeout(timer);
    timer = setTimeout(() => doSearch(q), 250);
  });
</script>
{% endblock %}
